#!/usr/bin/env zsh
# devuan-mate.blend


BLENDPATH="${BLENDPATH:-$(dirname $0)}"

source $BLENDPATH/config

blend_preinst() {
	fn blend_preinst
	req=(strapdir blend release)
	ckreq || return 1

	notice "executing ${blendname##*/} preinst"
	
}

blend_postinst() {
	fn blend_postinst
	req=(strapdir blendname os release)
	ckreq || return 1

	notice "executing ${blendname##*/} postinst - ${PWD}"	
	
	pushd $blendname/rootfs-overlay
		dirs=$(ls -l | awk '{print $9}')
	popd
	echo $dirs > $workdir/tmp_$$
	# Remove lines in blank:
	cat $workdir/tmp_$$ | sed '/^ *$/d' > $workdir/dirs_$$
	
	for i in $(cat $workdir/dirs_$$); do
		echo $i
		mkdir -p $strapdir/$i
		rsync -avx --no-o --no-g $blendname/rootfs-overlay/$i/* $strapdir/$i
	done
	
	# Remove temp files:
	rm -rf $workdir/tmp_$$ $workdir/dirs_$$
	
	for line in `find $blendname/rootfs-overlay/usr/bin -name "*"`; do
		[[ ${line##*/} != "bin" ]] && chmod -R 655 $strapdir/usr/bin/${line##*/}
	done

	for line in `find $blendname/rootfs-overlay/lib/live/config -name "*"`; do
		[[ ${line##*/} != "config" ]] && chmod -R 700 $strapdir/lib/live/config/${line##*/}
	done
	
	echo \
"# Xwrapper.config (Debian X Window System server wrapper configuration file)
#
# This file was generated by the post-installation script of the
# xserver-xorg-legacy package using values from the debconf database.
#
# See the Xwrapper.config(5) manual page for more information.
#
# This file is automatically updated on upgrades of the xserver-xorg-legacy
# package *only* if it has not been modified since the last upgrade of that
# package.
#
# If you have edited this file but would like it to be automatically updated
# again, run the following command as root:
#   dpkg-reconfigure xserver-xorg-legacy
allowed_users=anybody
needs_root_rights = no
" > $strapdir/etc/X11/Xwrapper.config

}

blend_finalize() {
	fn blend_finalize
	req=(R strapdir os mirror release)
	ckreq || return 1

	notice "executing $blend finalize"
	
	#cp -av $R/blends/$blend/dselect/pkglist.txt                    $strapdir/tmp/
	
	sed -i '12i Defaults    env_reset , timestamp_timeout = 0' $strapdir/etc/sudoers	

	echo \
"127.0.0.1       ${os}                localhost
::1              localhost            ip6-localhost ip6-loopback
fe00::0          ip6-localnet
fe00::0          ip6-mcastprefix
fe02::1          ip6-allnodes
fe02::1          ip6-allrouters" > $strapdir/etc/hosts

	cat <<EOF | sudo tee ${strapdir}/finalize >/dev/null
#!/bin/sh

rm -f vmlinuz.old initrd.img.old
dpkg-reconfigure xserver-xorg-legacy
apt-get autoremove
apt-get clean

	echo \
"
	echo \"
deb http://${mirror} ${release} main
deb-src http://${mirror} ${release} main

deb http://${mirror} ${release}-updates main
deb-src http://${mirror} ${release}-updates main

deb http://${mirror} ${release}-security main
deb-src http://${mirror} ${release}-security main\" > /etc/apt/sources.list

exit 0" >> /usr/bin/preseed-hack

EOF

	chroot-script -d finalize || zerr
	
}













